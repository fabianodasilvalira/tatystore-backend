# ============================================
# NGINX CONFIGURATION - TATYSTORE FRONTEND
# ============================================
# Configuração otimizada para produção com:
# - Segurança reforçada (headers, CSP, proteção de arquivos)
# - Performance (Gzip, cache, timeouts)
# - Suporte a SPA (Single Page Application)
# ============================================

server {
    # ------------------------------------------
    # CONFIGURAÇÕES BÁSICAS
    # ------------------------------------------
    
    # Porta que o Nginx vai escutar (HTTP)
    listen 80;
    
    # Nome do servidor (aceita qualquer domínio)
    # O Dokploy gerencia o proxy reverso e domínios
    server_name _;
    
    # Diretório raiz onde estão os arquivos estáticos
    # Aqui ficam os arquivos compilados do React (HTML, CSS, JS)
    root /usr/share/nginx/html;
    
    # Arquivo padrão a ser servido (index.html)
    index index.html;

    # ------------------------------------------
    # SEGURANÇA: OCULTAR VERSÃO DO NGINX
    # ------------------------------------------
    # Desabilita exibição da versão do Nginx nos headers
    # Previne que atacantes saibam qual versão está rodando
    server_tokens off;

    # ------------------------------------------
    # PERFORMANCE: COMPRESSÃO GZIP
    # ------------------------------------------
    # Comprime arquivos antes de enviar ao navegador
    # Reduz ~70% do tamanho de transferência
    
    # Ativa compressão Gzip
    gzip on;
    
    # Adiciona header Vary: Accept-Encoding
    # Importante para proxies e CDNs
    gzip_vary on;
    
    # Tamanho mínimo para comprimir (1KB)
    # Arquivos menores não compensam a compressão
    gzip_min_length 1024;
    
    # Nível de compressão (1-9)
    # 6 = bom equilíbrio entre tamanho e CPU
    gzip_comp_level 6;
    
    # Tipos de arquivo para comprimir
    # Não inclui imagens (já são comprimidas)
    gzip_types 
        text/plain              # Arquivos de texto
        text/css                # Folhas de estilo
        text/xml                # XML
        text/javascript         # JavaScript (legado)
        application/x-javascript    # JavaScript (legado)
        application/xml+rss     # RSS feeds
        application/javascript  # JavaScript moderno
        application/json        # JSON
        application/vnd.ms-fontobject  # Fontes EOT
        application/x-font-ttf  # Fontes TTF
        font/opentype           # Fontes OpenType
        image/svg+xml           # SVG
        image/x-icon;           # Ícones

    # ------------------------------------------
    # PERFORMANCE: CACHE DE ASSETS ESTÁTICOS
    # ------------------------------------------
    # Arquivos estáticos (JS, CSS, imagens, fontes)
    # Regex: ~* = case-insensitive
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        # Cache por 1 ano
        # Estes arquivos têm hash no nome, então são únicos
        expires 1y;
        
        # Header de cache: público e imutável
        # Navegadores podem cachear sem revalidar
        add_header Cache-Control "public, immutable";
        
        # Desabilita log de acesso (reduz I/O)
        access_log off;
    }

    # ------------------------------------------
    # ROTEAMENTO SPA (SINGLE PAGE APPLICATION)
    # ------------------------------------------
    # Todas as rotas retornam index.html
    # React Router gerencia as rotas no cliente
    location / {
        # Tenta servir arquivo, depois diretório, senão index.html
        # Essencial para SPAs funcionarem com rotas customizadas
        try_files $uri $uri/ /index.html;
        
        # ------------------------------------------
        # HEADERS DE SEGURANÇA
        # ------------------------------------------
        
        # X-Frame-Options: Previne clickjacking
        # SAMEORIGIN = permite apenas no mesmo domínio
        add_header X-Frame-Options "SAMEORIGIN" always;
        
        # X-Content-Type-Options: Previne MIME sniffing
        # nosniff = navegador respeita o Content-Type
        add_header X-Content-Type-Options "nosniff" always;
        
        # X-XSS-Protection: Proteção contra XSS (legado)
        # mode=block = bloqueia página se detectar XSS
        add_header X-XSS-Protection "1; mode=block" always;
        
        # Referrer-Policy: Controla informações de referência
        # strict-origin-when-cross-origin = envia apenas origem em HTTPS
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        
        # Permissions-Policy: Desabilita APIs sensíveis
        # Previne uso não autorizado de geolocalização, câmera, microfone
        add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
        
        # ------------------------------------------
        # CONTENT SECURITY POLICY (CSP)
        # ------------------------------------------
        # Define fontes permitidas para cada tipo de conteúdo
        # Previne injeção de scripts maliciosos (XSS)
        add_header Content-Security-Policy "
            default-src 'self';
            script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://aistudiocdn.com;
            style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://fonts.googleapis.com;
            font-src 'self' https://fonts.gstatic.com;
            img-src 'self' data: blob: http://localhost:8080 https:;
            connect-src 'self' http://localhost:8080 https://tatystore.cloud https://generativelanguage.googleapis.com;
            frame-ancestors 'self';
        " always;
        
        # Explicação do CSP:
        # - default-src 'self': padrão = apenas mesmo domínio
        # - script-src: permite scripts do próprio site + TailwindCSS + AI Studio
        # - style-src: permite estilos do próprio site + TailwindCSS + Google Fonts
        # - font-src: permite fontes do próprio site + Google Fonts
        # - img-src: permite imagens do próprio site + data URIs + qualquer HTTPS
        # - connect-src: permite conexões ao backend + API Gemini
        # - frame-ancestors 'self': previne que o site seja carregado em iframe
    }

    # ------------------------------------------
    # SEGURANÇA: PROTEÇÃO DE ARQUIVOS OCULTOS
    # ------------------------------------------
    # Bloqueia acesso a arquivos que começam com ponto (.)
    # Exemplos: .env, .git, .gitignore, .htaccess
    location ~ /\. {
        # Nega acesso (retorna 403 Forbidden)
        deny all;
        
        # Não loga tentativas de acesso (reduz spam nos logs)
        access_log off;
        log_not_found off;
    }

    # ------------------------------------------
    # SEGURANÇA: PROTEÇÃO DE ARQUIVOS DE CONFIGURAÇÃO
    # ------------------------------------------
    # Bloqueia acesso a arquivos sensíveis por extensão
    # Regex: ~* = case-insensitive
    location ~* \.(env|git|gitignore|dockerignore|md)$ {
        # Nega acesso (retorna 403 Forbidden)
        deny all;
        
        # Não loga tentativas de acesso
        access_log off;
        log_not_found off;
    }
    
    # Arquivos bloqueados:
    # - .env, .env.local, .env.production (variáveis de ambiente)
    # - .git, .gitignore (controle de versão)
    # - .dockerignore (configuração Docker)
    # - .md (arquivos de documentação)

    # ------------------------------------------
    # LIMITES: TAMANHO DE UPLOAD
    # ------------------------------------------
    # Limite máximo para upload de arquivos
    # 10MB é suficiente para a maioria dos casos
    # Ajuste se precisar fazer upload de arquivos maiores
    client_max_body_size 10M;

    # ------------------------------------------
    # TIMEOUTS: PROTEÇÃO CONTRA DOS
    # ------------------------------------------
    # Timeouts curtos previnem ataques de negação de serviço
    
    # Timeout para receber o corpo da requisição (12 segundos)
    client_body_timeout 12;
    
    # Timeout para receber os headers da requisição (12 segundos)
    client_header_timeout 12;
    
    # Timeout para manter conexão aberta (15 segundos)
    # Conexões idle são fechadas para liberar recursos
    keepalive_timeout 15;
    
    # Timeout para enviar resposta ao cliente (10 segundos)
    send_timeout 10;

    # ------------------------------------------
    # LOGS
    # ------------------------------------------
    # Logs de acesso: todas as requisições
    # Formato padrão do Nginx
    access_log /var/log/nginx/access.log;
    
    # Logs de erro: apenas warnings e erros
    # Útil para debug e monitoramento
    error_log /var/log/nginx/error.log warn;

    # ------------------------------------------
    # PÁGINAS DE ERRO CUSTOMIZADAS
    # ------------------------------------------
    # Em SPAs, erros 404 e 500 retornam index.html
    # React Router gerencia a página de erro no cliente
    
    # Erro 404: Página não encontrada
    error_page 404 /index.html;
    
    # Erros 500-504: Erros de servidor
    error_page 500 502 503 504 /index.html;
}

# ============================================
# RESUMO DO QUE ESTA CONFIGURAÇÃO FAZ:
# ============================================
# SEGURANÇA:
# - 7 headers de segurança configurados
# - CSP (Content Security Policy) detalhado
# - Proteção de arquivos sensíveis (.env, .git, etc)
# - Timeouts para prevenir DoS
# - Versão do Nginx oculta
#
# PERFORMANCE:
# - Compressão Gzip (reduz 70% do tamanho)
# - Cache de assets por 1 ano
# - Logs otimizados
#
# FUNCIONALIDADE:
# - Suporte completo a SPA (React Router)
# - Páginas de erro customizadas
# - Limite de upload configurado
# ============================================

# ============================================
# TESTAR CONFIGURAÇÃO:
# ============================================
# Dentro do container:
#   nginx -t
#
# Ver logs em tempo real:
#   tail -f /var/log/nginx/access.log
#   tail -f /var/log/nginx/error.log
#
# Testar headers de segurança:
#   curl -I https://seudominio.com
#
# Testar arquivos protegidos:
#   curl https://seudominio.com/.env (deve retornar 403)
# ============================================
